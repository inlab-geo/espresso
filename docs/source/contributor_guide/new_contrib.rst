==================
Create new example
==================

ðŸ‘‹ Everyone is welcomed to contribute with their own forward code. We aim to reduce the
barrier of contributing so don't worry if you are not familiar with some technical
stuff - we are here to help.


Add your own Espresso problem
-----------------------------

#. A new contribution to Espresso has to conform to a consistent
   file structure. The simplest way to ensure that a new contribution includes
   all files is to start the creation of a new problem from the template. Run the 
   following command from the the path to Espresso:

   .. code-block:: bash

        python espresso_machine/new_contribution/create_new_contrib.py <problem-name>

   Replacing :code:`problem-name` with your Espresso problem name in snake case 
   (e.g. :code:`gravity_density`, :code:`polynomial_regression`). Remember to choose a 
   sensible, unique name for your contribution that makes it easy to understand what 
   the example is about.

#. Navigate to folder :code:`<path-to-espresso>/src/espresso/contrib/<problem-name>`, and you'll see template 
   files needed for a new contribution. Each Espresso example is organised around a
   central class object that contains, at minimum, a set of functions with names
   that are shared by all examples.

   .. figure:: ../_static/contrib_edit1.png
    :align: center

#. Now the folder is all yours, get started with the following checklist.

   .. dropdown:: Checklist and tips
      :icon: tasklist
      :open:

      - ``src/espresso/contrib/<problem-name>/README.md``

        - Document anything you'd like to add for this problem, such as the what the 
          problem is about and some brief intro of the theory behind.
        - This will be automatically rendered into :doc:`../user_guide/contrib/index`.

      - ``src/espresso/contrib/<problem-name>/LICENCE``
      
        - We use a 2-clause BSD licence as the default one. Feel free to replace it
          with a licence that suits you best.

      - ``src/espresso/contrib/<problem-name>/<problem-name>.py``

        - The development will be centred around the autogenerated class 
          ``ProblemName``. It is a subclass of 
          :doc:`EspressoProblem <../user_guide/api/generated/espresso.EspressoProblem>`
          so you might find the API reference helpful.
        - All standard attributes have been declared in the template but are left for 
          you to implement. You'll see that some are required (with ``TODO``) and 
          others are optional.
        - If you would like to load data from files, please use our 
          :doc:`utility functions <../user_guide/api/generated/espresso.utils>`
          to get the absolute path before calling your loading function.
        - Apart from the standard attributes, there are many more functions and values 
          that a new contribution can contain, for examples:

          - inversion_suggestion: a string containing inversion suggestions
          - reg_param_suggestion: a sensible value for regularization parameter
          - dx: spatial resolution in x-direction
          - dt: temporal resolution
          - nt: number of time steps
          - The possibilities are endless! Whatever information you find helpful is
            probably also helpful for the users. Simply attach them to the problem 
            class as additional attributes.
         
        - We aim to follow `Python PEP8 style conventions <https://peps.python.org/pep-0008/>`_
          to make source code readable. Though not strictly enforced, we recommend
          `Black formatter <https://github.com/psf/black#installation-and-usage>`_ and
          `PyLint <https://github.com/pylint-dev/pylint#install>`_ to maintain a good 
          coding style.
         
      - ``pyproject.toml``, in particular the ``INSTALL_REQUIRES`` variable, if needed.
   
#. Test running your code. 

   .. dropdown:: Troubleshooting: issue with relative import
      :icon: tools

      Note that you might see an error if you have any relative import in the main Python 
      file:

      .. code-block:: python

         # file: <problem-name>.py

         from .lib import *

      In this case, use ``contrib`` as your working directory and import your contribution
      in the following example way:

      .. code-block:: pycon

         $ pwd                                        # check you are in the right folder
         <path-to-espresso>/src/espresso/contrib
         $ python
         >>> from example_name import ExampleName     # ...and import this way
      
      Or the following example if you are running a file:

      .. code-block:: python

         # file: contrib/tmp.py                       # create tmp file in the right folder
         from example_name import ExampleName         # ...and import this way

#. Validate your code with Espresso by running:

   .. code-block:: console

      $ python test/test_examples -c <example_name>


Jupyter Notebook
----------------

Additionally, we encourage you to add a Jupyter Notebook with an identical name
into the folder Jupyter Notebooks that contains the following:

1. An extensive description of the new Espresso Problem, containing
   information about (but not limited to):

   - the forward calculation (ie. the underlying physics) and how it was implemented.
   - which inversion method is used (and regularisation) and how it was implemented.
   - the physical unit of relevant variables, but at least of ``model`` and ``data``.
   - all changeable parameters, possibly in a list.


2. An example of the new problem being used, with a reasonable output.

